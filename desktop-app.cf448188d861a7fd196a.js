webpackJsonp([3],{"./src/desktop/app.tsx":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s("./node_modules/react/index.js"),i=s("./node_modules/react-dom/index.js"),o=s("./src/desktop/views/Home.tsx");localStorage.setItem("debug","swift*"),i.render(n.createElement(o.default,null),document.getElementById("swift"))},"./src/desktop/views/Home.tsx":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s("./node_modules/react/index.js"),i=s("./src/shared/components/SessionDisplay.tsx"),o=s("./src/shared/components/SessionScanner.tsx"),a=s("./src/shared/RTCClient.ts");t.default=class extends n.PureComponent{constructor(e,t){super(e,t),this.onSessionScanned=(e=>{this.client.connectTo(e)}),this.client=new a.default}render(){return n.createElement("div",{className:"home"},n.createElement(i.default,{client:this.client}),n.createElement(o.default,{onSessionScanned:this.onSessionScanned}))}}},"./src/shared/GatewayClient.ts":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s("./node_modules/debug-logger/debug-logger.js"),i=s("./node_modules/events/events.js"),o=s("./node_modules/socket.io-client/lib/index.js"),a=n("swift:GatewayClient");t.default=class extends i.EventEmitter{constructor(){super(),this.socket=o("https://swift-gateway.herokuapp.com",{transports:["websocket"],autoConnect:!1}),this.socket.on("data",({fromId:e,data:t})=>{a("received data",t),this.emit("message",e,t)}),this.socket.on("error",e=>a(e)),this.socket.on("disconnect",()=>{a(`${this.localId}: Disconnected from the gateway`),this.emit("disconnected")})}connect(){return this.socket.connected?Promise.resolve():new Promise((e,t)=>{this.socket.connect(),this.socket.once("connect",()=>{a(`${this.localId}: Connected to the gateway`),this.socket.removeListener("connect_error"),this.socket.removeListener("connect_timeout"),e()}),this.socket.once("connect_error",t),this.socket.once("connect_timeout",t)})}get isConnected(){return this.socket.connected}get localId(){return this.socket.id}disconnect(){this.socket.connected&&(this.socket.disconnect(),this.socket.removeListener("connect_error"),this.socket.removeListener("connect_timeout"))}send(e,t){a("sending to",t,"to",e),this.socket.emit("data",{remoteId:e,data:t})}}},"./src/shared/RTCClient.ts":function(e,t,s){"use strict";var n=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(i,o){function a(e){try{d(n.next(e))}catch(e){o(e)}}function c(e){try{d(n.throw(e))}catch(e){o(e)}}function d(e){e.done?i(e.value):new s(function(t){t(e.value)}).then(a,c)}d((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const i=s("./node_modules/debug-logger/debug-logger.js"),o=s("./node_modules/events/events.js"),a=s("./src/shared/GatewayClient.ts"),c=i("swift:RTCClient");t.default=class extends o.EventEmitter{constructor(){super(),this.sessionCreating=!1,this.sessionCreated=!1,this.onGatewayMessage=((e,t)=>n(this,void 0,void 0,function*(){if(this.remoteId=e,c("received message",t),"offer"===t.type){this.pc.setRemoteDescription(new RTCSessionDescription(t.sessionDescription));const s=yield this.pc.createAnswer();this.pc.setLocalDescription(s),this.gatewayClient.send(e,{type:"answer",sessionDescription:s})}else if("answer"===t.type)this.pc.setRemoteDescription(t.sessionDescription);else if("candidate"===t.type){const e=new RTCIceCandidate({sdpMLineIndex:t.candidate.sdpMLineIndex,candidate:t.candidate.candidate});this.pc.addIceCandidate(e)}})),this.onSendChannelOpen=(e=>{c("data channel opened"),this.setupDataChannel()}),this.onSendChannelClose=(e=>{c("onSendChannelClose",e)}),this.onDataChannel=(e=>{c("data channel opened"),this.sendChannel=e.channel,this.setupDataChannel()}),this.onLocalIceCandidate=(e=>{e.candidate&&this.gatewayClient.send(this.remoteId,{type:"candidate",candidate:{sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid,candidate:e.candidate.candidate}})}),this.gatewayClient=new a.default,this.gatewayClient.on("message",this.onGatewayMessage),this.gatewayClient.on("disconnected",()=>{this.sessionCreating=!1,this.sessionCreated&&(this.sessionCreated=!1,this.emit("sessionStopped"))});try{this.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),this.pc.onicecandidate=this.onLocalIceCandidate,this.pc.ondatachannel=this.onDataChannel,this.sendChannel=this.pc.createDataChannel("Swift Data Channel"),this.sendChannel.onopen=this.onSendChannelOpen,this.sendChannel.onclose=this.onSendChannelClose}catch(e){c(e)}}get localId(){return this.gatewayClient.localId}startSession(){return n(this,void 0,void 0,function*(){this.sessionCreating||(this.sessionCreating=!0,yield this.gatewayClient.connect(),this.sessionCreating=!1,this.sessionCreated=!0,this.emit("sessionStarted",this.gatewayClient.localId))})}connectTo(e){return n(this,void 0,void 0,function*(){c("connectTo",e),this.gatewayClient.isConnected&&(yield this.gatewayClient.connect()),this.remoteId=e,c("create offer");const t=yield this.pc.createOffer();c("offer created"),yield this.pc.setLocalDescription(t),c("sending session desciption",t),this.gatewayClient.send(e,{type:"offer",sessionDescription:t})})}setupDataChannel(){window.sendMessage=(e=>{this.sendChannel.send(JSON.stringify(e))}),this.sendChannel.onmessage=(e=>{console.log(JSON.parse(e.data))})}}},"./src/shared/components/SessionDisplay.tsx":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s("./node_modules/qrcode.react/lib/index.js"),i=s("./node_modules/react/index.js");t.default=class extends i.PureComponent{constructor(e,t){super(e,t),this.onSessionStarted=(e=>{this.setState({sessionId:e,sessionCreating:!1})}),this.onSessionStopped=(()=>{this.setState({sessionId:void 0,sessionCreating:!1})}),this.state={sessionCreating:!0},e.client.startSession()}componentWillMount(){this.props.client.on("sessionStarted",this.onSessionStarted),this.props.client.on("sessionEnd",this.onSessionStopped)}componentWillUnmount(){this.props.client.removeListener("sessionStarted",this.onSessionStarted),this.props.client.removeListener("onSessionStopped",this.onSessionStarted)}render(){const{sessionId:e,sessionCreating:t}=this.state;return i.createElement("div",{className:"session-display"},t&&"Creating a session...",e?i.createElement("div",{className:"session-display__qr-area"},i.createElement(n,{value:e,size:256}),i.createElement("div",{className:"session-display__id"},"id: "+e)):null)}}},"./src/shared/components/SessionScanner.tsx":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s("./node_modules/debug-logger/debug-logger.js"),i=s("./node_modules/instascan/index.js"),o=s("./node_modules/react/index.js"),a=n("swift:SessionScanner");t.default=class extends o.PureComponent{constructor(e,t){super(e,t),this.scan=(()=>{this.setState({isScanning:!0},()=>{i.Camera.getCameras().then(e=>{e.length>0?this.scanner.start(e[1]||e[0]):(this.setState({isScanning:!1}),a("No cameras found."))}).catch(e=>{this.setState({isScanning:!1}),a(e)})})}),this.stopScanning=(()=>{this.scanner.stop()}),this.state={isScanning:!1}}componentDidMount(){this.scanner=new i.Scanner({video:this.videoElt,mirror:!1}),this.scanner.addListener("scan",e=>{this.scanner.stop(),this.setState({isScanning:!1},()=>this.props.onSessionScanned(e))})}render(){const{isScanning:e}=this.state;return o.createElement("div",{className:"session-scanner"},e?o.createElement("button",{onClick:this.stopScanning},"Stop scanning"):o.createElement("button",{onClick:this.scan},"scan QR code"),o.createElement("video",{ref:e=>this.videoElt=e}))}}},0:function(e,t){},1:function(e,t){},2:function(e,t){},3:function(e,t){}},["./src/desktop/app.tsx"]);
//# sourceMappingURL=desktop-app.cf448188d861a7fd196a.js.map